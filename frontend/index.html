<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peso Ideal</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <!-- Nesta tela deverá ter os botões Incluir, Alterar, Excluir e Pesquisar. Todos os
        4 deverão ir no server. O botão Alterar e Excluir deverá ser chamado somente
        depois do Pesquisar. -->
        <h2>Peso Ideal Baseado na altura e 
            sexo de pessoas cadastradas</h2>
    
        <form id="formPessoa">
            <label for="id">ID:</label>
            <input type="number" name="id" id="id">
    
            <label for="nome">Nome:</label>
            <input type="text" name="nome" id="nome">
    
            <label for="data_nascimento">Data de nascimento:</label>
            <input type="date" name="data_nascimento" id="data_nascimento">
    
            <label for="sexo">Sexo:</label>
            <select name="sexo" id="sexo" required>
                <option value="M">Masculino</option>
                <option value="F">Feminino</option>
            </select>
    
            <label for="cpf">CPF (somente números):</label>
            <input type="text" name="cpf" id="cpf">
    
            <label for="peso">Peso (em quilos):</label>
            <input type="number" step="0.1" name="peso" id="peso">
    
            <label for="altura">Altura (em metros):</label>
            <input type="number" step ="0.1" name="altura" id="altura" required>
            <div class="btn-visiveis">
                <button type="button" onclick="enviar('pesquisar')">Pesquisar</button>
                <button type="button" onclick="enviar('incluir')">Incluir</button>
            </div>
            <div class="btn-invisiveis">
                <button type="button" onclick="enviar('alterar')">Alterar</button>
                <button type="button" onclick="enviar('excluir')">Excluir</button>
            </div>
            <div class="peso-ideal-div" style="display: none;">
                <button class="peso-ideal" type="button" onclick="calcularPesoIdeal()">Calcular Peso Ideal</button>
            </div>
        </form>
    <div id="loadingIndicator" class="loading-indicator" style="display: none;">Carregando...</div>
    <div id="resultado" class="resultado"></div>
        
    </div>

    <script>
        const loadingIndicator = document.getElementById('loadingIndicator');

        const showLoading = () => {
            loadingIndicator.style.display = 'flex';
        };

        const hideLoading = () => {
            loadingIndicator.style.display = 'none';
        };

        const getFormData = () => {
            const form = document.getElementById('formPessoa');
            const data = new FormData(form);
            return Object.fromEntries(data.entries());
        }
        const calcularPesoIdeal = async () => {
            const id = document.getElementById('id').value;
            const resultadoDiv = document.getElementById('resultado');
            resultadoDiv.innerText = ''; // Clear previous messages

            if (!id) {
                resultadoDiv.innerText = 'Por favor, pesquise uma pessoa primeiro.';
                return;
            }

            showLoading();
            try {
                let url =  `http://localhost:8010/api/v1/pessoa/${id}/peso-ideal/`
                const response = await fetch(url, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' },
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    resultadoDiv.innerText = 'Erro ao calcular peso ideal: ' + (errorData.error || response.statusText);
                    return;
                }
                const data = await response.json();
                if (data.peso_ideal === undefined) {
                    resultadoDiv.innerText = 'Não foi possível calcular o peso ideal.';
                    return;
                }

                resultadoDiv.innerText = 'Peso Ideal: ' + data.peso_ideal.toFixed(2) + ' kg';
            } catch (error) {
                resultadoDiv.innerText = 'Erro de conexão: ' + error.message;
            } finally {
                hideLoading();
            }

        }
        const enviar = async (acao) => {
            const dados = getFormData();
            const resultadoDiv = document.getElementById('resultado');
            resultadoDiv.innerText = ''; // Clear previous messages
            
            let url = 'http://localhost:8010/api/v1/pessoa/';
            let method = 'POST';
            let map_acao = {
                incluir: ['POST', ''],
                alterar: ['PUT', `${dados.id}/`],
                excluir: ['DELETE', `${dados.id}/`],
                pesquisar: ['GET', `${dados.id || ''}`]
            };
            if (!acao in map_acao) {
                resultadoDiv.innerText = 'Ação inválida';
                return;
            } 
            method = map_acao[acao][0];
            url += map_acao[acao][1];

            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                }
            };

            if (method !== 'GET' && method !== 'DELETE') {
                options.body = JSON.stringify(dados);
            }

            showLoading();
            try {
                const response = await fetch(url, options)
                if (!response.ok) {
                    const errorData = await response.json();
                    if (response.status === 404) {
                        resultadoDiv.innerText = 'Usuário não encontrado.';
                    } else {
                        resultadoDiv.innerText = 'Erro na operação: ' + (errorData.error || response.statusText);
                    }
                    return;
                }
                const data = await response.json();
                if (acao == 'pesquisar') {
                    if (Array.isArray(data)) {
                        if (data.length > 1) {
                            resultadoDiv.innerText = 'Múltiplos registros encontrados. Por favor, especifique um ID para editar/excluir.';
                            // Clear form
                            formPessoa.reset();
                            document.getElementById('id').value = '';
                            document.querySelector('.btn-invisiveis').classList.remove('btn-visiveis');
                            document.querySelector('.btn-invisiveis').classList.add('btn-invisiveis');
                            document.querySelector('.peso-ideal-div').style.display = 'none';
                            document.querySelector('.peso-ideal-div').classList.remove('btn-visiveis');
                            return;
                        } else if (data.length === 0) {
                            resultadoDiv.innerText = 'Nenhum registro encontrado.';
                            formPessoa.reset();
                            document.getElementById('id').value = '';
                            document.querySelector('.btn-invisiveis').classList.remove('btn-visiveis');
                            document.querySelector('.btn-invisiveis').classList.add('btn-invisiveis');
                            document.querySelector('.peso-ideal-div').style.display = 'none';
                            document.querySelector('.peso-ideal-div').classList.remove('btn-visiveis');
                            return;
                        }
                        // If only one item in array, treat as single object
                        const pessoa = data[0];
                        document.getElementById('nome').value = pessoa.nome;
                        document.getElementById('data_nascimento').value = pessoa.data_nascimento;
                        document.getElementById('sexo').value = pessoa.sexo;
                        document.getElementById('id').value = pessoa.id;
                        document.getElementById('cpf').value = pessoa.cpf;
                        document.getElementById('peso').value = pessoa.peso;
                        document.getElementById('altura').value = pessoa.altura;
                        document.querySelector('.btn-invisiveis').classList.add('btn-visiveis');
                        document.querySelector('.btn-invisiveis').classList.remove('btn-invisiveis');
                        document.querySelector('.peso-ideal-div').style.display = 'block';
                        document.querySelector('.peso-ideal-div').classList.add('btn-visiveis');
                    } else { // Single object
                        const pessoa = data;
                        document.getElementById('nome').value = pessoa.nome;
                        document.getElementById('data_nascimento').value = pessoa.data_nascimento;
                        document.getElementById('sexo').value = pessoa.sexo;
                        document.getElementById('id').value = pessoa.id;
                        document.getElementById('cpf').value = pessoa.cpf;
                        document.getElementById('peso').value = pessoa.peso;
                        document.getElementById('altura').value = pessoa.altura;
                        document.querySelector('.btn-invisiveis').classList.add('btn-visiveis');
                        document.querySelector('.btn-invisiveis').classList.remove('btn-invisiveis');
                        document.querySelector('.peso-ideal-div').style.display = 'block';
                        document.querySelector('.peso-ideal-div').classList.add('btn-visiveis');
                    }
                } else if (acao == 'incluir') {
                    const pessoa = data;
                    document.getElementById('nome').value = pessoa.nome;
                    document.getElementById('data_nascimento').value = pessoa.data_nascimento;
                    document.getElementById('sexo').value = pessoa.sexo;
                    document.getElementById('id').value = pessoa.id;
                    document.getElementById('cpf').value = pessoa.cpf;
                    document.getElementById('peso').value = pessoa.peso;
                    document.getElementById('altura').value = pessoa.altura;
                    document.querySelector('.btn-invisiveis').classList.add('btn-visiveis');
                    document.querySelector('.btn-invisiveis').classList.remove('btn-invisiveis');
                    document.querySelector('.peso-ideal-div').style.display = 'block';
                    document.querySelector('.peso-ideal-div').classList.add('btn-visiveis');
                    resultadoDiv.innerText = 'Pessoa incluída com sucesso!';
                } else if (acao == 'alterar') {
                    resultadoDiv.innerText = 'Pessoa alterada com sucesso!';
                } else if (acao == 'excluir') {
                    resultadoDiv.innerText = 'Pessoa excluída com sucesso!';
                    formPessoa.reset();
                    document.getElementById('id').value = '';
                    document.querySelector('.btn-invisiveis').classList.remove('btn-visiveis');
                    document.querySelector('.btn-invisiveis').classList.add('btn-invisiveis');
                    document.querySelector('.peso-ideal-div').style.display = 'none';
                    document.querySelector('.peso-ideal-div').classList.remove('btn-visiveis');
                }
            } catch (error) {
                resultadoDiv.innerText = 'Erro de conexão: ' + error.message;
            } finally {
                hideLoading();
            }
            
        }
    </script>
</body>
</html>